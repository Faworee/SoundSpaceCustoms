<!DOCTYPE html>
<html lang="en"> 
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://i.imgur.com/h9ZS3fW.png">
<title>Sound Space Custom Maps</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
    color: white;
    font-family: 'Segoe UI', Arial, sans-serif;
    padding: 20px;
    min-height: 100vh;
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1800px;
    margin: 0 auto 30px;
    gap: 20px;
}

.logo {
    font-size: 1.8em;
    font-weight: bold;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    flex-shrink: 0;
}

.header-actions {
    position: relative;
    flex-shrink: 0;
}

.menu-toggle {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.2), rgba(240, 147, 251, 0.2));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1em;
    transition: all 0.3s ease;
}

.menu-toggle:hover {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.3), rgba(240, 147, 251, 0.3));
    transform: translateY(-2px);
}

.dropdown-menu {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    background: rgba(20, 20, 30, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 12px;
    min-width: 220px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-item {
    display: block;
    padding: 12px 16px;
    color: white;
    text-decoration: none;
    border-radius: 10px;
    transition: background 0.2s;
    cursor: pointer;
    margin-bottom: 4px;
}

.dropdown-item:hover {
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.3), rgba(240, 147, 251, 0.3));
}

.tracking-toggle-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 4px;
}

.tracking-toggle-label {
    color: white;
    font-size: 0.9em;
    margin-right: 10px;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
    background: #dc3545;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s;
}

.toggle-switch.active {
    background: #28a745;
}

.toggle-slider {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.toggle-switch.active .toggle-slider {
    transform: translateX(26px);
}

.search-container {
    max-width: 1800px;
    margin: 0 auto 10px;
}

.search-wrapper {
    position: relative;
    display: flex;
    gap: 12px;
    align-items: stretch;
    margin-bottom: 15px;
}

.search-input {
    flex: 1;
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    color: white;
    font-size: 1em;
    transition: all 0.3s ease;
    min-width: 0;
}

.search-input:focus {
    outline: none;
    border-color: rgba(79, 172, 254, 0.5);
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 0 20px rgba(79, 172, 254, 0.2);
}

.search-type-dropdown {
    padding: 16px 20px;
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.2), rgba(240, 147, 251, 0.2));
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    color: white;
    cursor: pointer;
    font-size: 1em;
    min-width: 150px;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.search-type-dropdown:focus {
    outline: none;
    border-color: rgba(79, 172, 254, 0.5);
    box-shadow: 0 0 20px rgba(79, 172, 254, 0.2);
}

.search-type-dropdown option {
    background: #1a1a2e;
    color: white;
}

.active-filters {
    max-width: 1800px;
    margin: 0 auto 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    min-height: 28px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.active-filters-label {
    font-size: 0.9em;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 600;
}

.filter-tag {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.3), rgba(240, 147, 251, 0.3));
    border: 1px solid rgba(79, 172, 254, 0.5);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-tag .remove-filter {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2em;
    line-height: 1;
    padding: 0;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.clear-all-filters {
    background: rgba(255, 59, 59, 0.2);
    border: 1px solid rgba(255, 59, 59, 0.4);
    padding: 6px 14px;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s;
}

.clear-all-filters:hover {
    background: rgba(255, 59, 59, 0.3);
}

.filter-bar {
    max-width: 1800px;
    margin: 0 auto 30px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-btn {
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
}

.sort-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.sort-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9em;
}

.sort-select {
    padding: 10px 16px;
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.2), rgba(240, 147, 251, 0.2));
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: white;
    cursor: pointer;
    min-width: 180px;
    font-size: 0.9em;
}

.sort-select option {
    background: #1a1a2e;
    color: white;
}

.map-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
    max-width: 1800px;
    margin: 0 auto;
    padding-bottom: 40px;
    align-items: start;
}

.map-card {
    background: linear-gradient(135deg, rgba(30, 30, 45, 0.6), rgba(20, 20, 30, 0.8));
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 28px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    min-height: 420px;
}

.map-card:hover {
    transform: translateY(-8px);
    border-color: rgba(79, 172, 254, 0.5);
    box-shadow: 0 20px 60px rgba(79, 172, 254, 0.3);
}

.map-card.easy { border-color: rgba(40, 167, 69, 0.5); }
.map-card.medium { border-color: rgba(255, 165, 0, 0.5); }
.map-card.hard { border-color: rgba(255, 0, 0, 0.5); }
.map-card.logic { border-color: rgba(128, 0, 128, 0.5); }
.map-card.brrrr { border-color: rgba(255, 255, 255, 0.5); }
.map-card.tasukete { border-color: rgba(93, 173, 226, 0.5); }

.new-badge {
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
    color: white;
    padding: 4px 12px;
    font-size: 0.7em;
    font-weight: bold;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 5;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.star-rating {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1));
    border: 1px solid rgba(255, 215, 0, 0.3);
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 0.9em;
    color: #ffd700;
    font-weight: 600;
}

.favorite-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.4em;
    padding: 4px;
    transition: transform 0.2s;
    line-height: 1;
    color: #ff3b3b;
    position: relative;
    z-index: 10;
}

.favorite-btn:hover {
    transform: scale(1.2);
}

.favorite-btn .heart-outline {
    display: inline;
}

.favorite-btn .heart-filled {
    display: none;
}

.favorite-btn.favorited .heart-outline {
    display: none;
}

.favorite-btn.favorited .heart-filled {
    display: inline;
}

.card-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
}

.info-display {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 8px;
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.8);
    height: 60px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    overflow: hidden;
}

.map-title {
    font-size: 1.1em;
    font-weight: 600;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1.3;
    word-break: break-word;
    height: 2.6em;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.map-title a {
    color: inherit;
    text-decoration: none;
    background: inherit;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.artist-name {
    color: #ffd700;
    font-size: 0.95em;
    word-break: break-word;
    line-height: 1.3;
    height: 1.3em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.map-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.85em;
    color: rgba(255, 255, 255, 0.7);
}

.info-item {
    display: flex;
    align-items: center;
    gap: 6px;
    height: 1.5em;
}

.info-item img {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.difficulty-emoji {
    cursor: help;
    position: relative;
    display: inline-block;
}

.difficulty-tooltip {
    visibility: hidden;
    background-color: rgba(0, 0, 0, 0.9);
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 5px 10px;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 0.85em;
    opacity: 0;
    transition: opacity 0.3s;
}

.difficulty-emoji:hover .difficulty-tooltip {
    visibility: visible;
    opacity: 1;
}

.patterns-display {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 8px;
    font-size: 0.8em;
    color: rgba(255, 255, 255, 0.8);
    height: 80px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    overflow: hidden;
}

.patterns-display strong {
    display: block;
    margin-bottom: 2px;
    flex-shrink: 0;
}

.patterns-list {
    margin: 0;
    padding: 0;
    list-style: none;
    display: inline;
}

.patterns-list li {
    display: inline;
}

.patterns-list li:not(:last-child)::after {
    content: ", ";
}

.card-footer {
    display: flex;
    gap: 8px;
    margin-top: auto;
    padding-top: 12px;
}

.action-btn {
    flex: 1;
    padding: 10px;
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.3), rgba(240, 147, 251, 0.3));
    border: 1px solid rgba(79, 172, 254, 0.4);
    border-radius: 12px;
    color: white;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.2s;
}

.action-btn:hover {
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.4), rgba(240, 147, 251, 0.4));
    transform: translateY(-2px);
}

.action-btn.copied {
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.3), rgba(40, 200, 80, 0.3));
    border-color: rgba(40, 167, 69, 0.5);
}

.more-btn {
    width: 40px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    cursor: pointer;
    font-size: 1.2em;
    transition: all 0.2s;
    position: relative;
}

.more-btn:hover {
    background: rgba(255, 255, 255, 0.12);
}

.more-actions-dropdown {
    position: absolute;
    bottom: calc(100% + 8px);
    right: 0;
    background: rgba(20, 20, 30, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 8px;
    min-width: 120px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.2s ease;
    z-index: 100;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}

.more-actions-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.more-actions-dropdown .dropdown-action {
    display: block;
    padding: 8px 12px;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    transition: background 0.2s;
    cursor: pointer;
    font-size: 0.85em;
    white-space: nowrap;
}

.more-actions-dropdown .dropdown-action:hover {
    background: linear-gradient(90deg, rgba(79, 172, 254, 0.3), rgba(240, 147, 251, 0.3));
}

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 2000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: rgba(20, 20, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 30px;
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 1.5em;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.2s;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.filter-section {
    margin-bottom: 24px;
}

.filter-section h3 {
    font-size: 1.1em;
    margin-bottom: 12px;
    color: rgba(255, 255, 255, 0.9);
}

.filter-options {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-option {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9em;
}

.filter-option.active {
    background: linear-gradient(90deg, #28a745, #218838);
    border-color: transparent;
    color: white;
}

.range-slider {
    margin-top: 10px;
}

.slider-inputs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.slider-input {
    flex: 1;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 0.9em;
}

.dual-range-slider {
    position: relative;
    height: 40px;
    margin: 10px 0;
}

.slider-track {
    position: absolute;
    height: 6px;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    border-radius: 3px;
    top: 17px;
}

.slider-thumb {
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border: 3px solid #4facfe;
    border-radius: 50%;
    top: 10px;
    margin-left: -10px;
    cursor: pointer;
    transition: transform 0.1s;
}

.slider-thumb:hover {
    transform: scale(1.2);
}

.slider-thumb.active {
    transform: scale(1.3);
    border-color: #f093fb;
}

.loading-spinner {
    display: none;
    margin: 50px auto;
    width: 50px;
    height: 50px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    100% { transform: rotate(360deg); }
}

.load-more-container {
    max-width: 1800px;
    margin: 40px auto;
    text-align: center;
}

.load-more-btn {
    background: linear-gradient(90deg, #4facfe, #f093fb);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 16px 40px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.load-more-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
}

.load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.popup {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    display: none;
    z-index: 3000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    max-width: 90%;
    text-align: center;
}

.cookie-consent {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(20, 20, 30, 0.98);
    backdrop-filter: blur(20px);
    border-top: 2px solid rgba(79, 172, 254, 0.3);
    padding: 20px;
    z-index: 10000;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
    display: none;
}

.cookie-consent.show {
    display: block;
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.cookie-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
}

.cookie-text {
    flex: 1;
    min-width: 300px;
}

.cookie-text h3 {
    margin: 0 0 8px 0;
    font-size: 1.2em;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.cookie-text p {
    margin: 0;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95em;
    line-height: 1.5;
}

.cookie-text a {
    color: #4facfe;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}

.cookie-text a:hover {
    border-bottom-color: #4facfe;
}

.cookie-actions {
    display: flex;
    gap: 12px;
    flex-shrink: 0;
}

.cookie-btn {
    padding: 12px 28px;
    border-radius: 12px;
    font-size: 1em;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-weight: 600;
}

.cookie-accept {
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    color: white;
}

.cookie-accept:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
}

.cookie-decline {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.cookie-decline:hover {
    background: rgba(255, 255, 255, 0.15);
}

body.low-quality .map-card {
    backdrop-filter: none;
    background: rgba(30, 30, 45, 0.9);
}

body.low-quality .map-card:hover {
    box-shadow: none;
}

body.low-quality * {
    transition: none !important;
    animation: none !important;
}

.changelog-content {
    max-height: 60vh;
    overflow-y: auto;
}

.changelog-entry {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-left: 3px solid #4facfe;
    border-radius: 8px;
}

.changelog-version {
    font-size: 1.1em;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 5px;
}

.changelog-date {
    font-size: 0.85em;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 10px;
}

.changelog-changes {
    list-style-position: inside;
    color: rgba(255, 255, 255, 0.9);
}

.changelog-changes li {
    margin-bottom: 5px;
}

.nate-confetti {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    animation: confetti-fall linear forwards;
    object-fit: contain;
}

@keyframes confetti-fall {
    0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(calc(100vh + 100px)) translateX(var(--drift)) rotate(var(--rotation));
        opacity: 0;
    }
}

.secret-share-modal .modal-content {
    text-align: center;
}

.secret-share-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.secret-share-btn {
    padding: 12px 30px;
    border-radius: 12px;
    font-size: 1em;
    cursor: pointer;
    border: none;
    font-weight: 600;
    transition: all 0.3s;
}

.secret-share-yes {
    background: linear-gradient(90deg, #28a745, #218838);
    color: white;
}

.secret-share-yes:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
}

.secret-share-no {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.secret-share-no:hover {
    background: rgba(255, 255, 255, 0.15);
}

.username-input-container {
    margin-top: 20px;
}

.username-input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.08);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 1em;
    margin-bottom: 15px;
}

.username-input:focus {
    outline: none;
    border-color: rgba(79, 172, 254, 0.5);
    background: rgba(255, 255, 255, 0.12);
}

.username-submit-btn {
    padding: 12px 30px;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.username-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
}

.start-from-modal .slider-inputs {
    display: flex;
    gap: 15px;
    margin: 20px 0;
}

.start-from-modal .slider-input {
    flex: 1;
}

.start-from-apply {
    padding: 12px 30px;
    background: linear-gradient(90deg, #4facfe, #f093fb);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    width: 100%;
    margin-top: 15px;
}

.start-from-apply:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
}

@media (max-width: 768px) {
    .map-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
    }
    
    .header-container {
        flex-wrap: nowrap;
    }
    
    .logo {
        font-size: 1.4em;
    }
    
    .search-wrapper {
        flex-wrap: wrap;
    }
    
    .search-input {
        width: 100%;
        flex-basis: 100%;
    }
    
    .search-type-dropdown {
        width: 100%;
        min-width: 100%;
    }
}

@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .logo {
        font-size: 1.2em;
    }
    
    .menu-toggle {
        padding: 10px 18px;
        font-size: 0.9em;
    }
}
</style>
</head>
<body>

<audio id="buttonSound" preload="auto">
    <source src="button.mp3" type="audio/mpeg">
</audio>

<div class="header-container">
    <div class="logo">Sound Space Maps</div>
    <div class="header-actions">
        <button class="menu-toggle" id="menuToggle">‚ò∞ Menu</button>
        <div class="dropdown-menu" id="headerMenu">
            <a href="https://discord.gg/872M5HPbYx" class="dropdown-item" target="_blank" rel="noopener">Join our Discord</a>
            <div class="dropdown-item" id="randomMapBtn">Random Map</div>
            <a href="/SubmitMaps" class="dropdown-item">Submit Map</a>
            <div class="dropdown-item" id="updateLogBtn">Update Log</div>
            <div class="dropdown-item" id="qualityToggle">Low Quality Mode</div>
            <div class="tracking-toggle-container">
                <span class="tracking-toggle-label">Map Copy Tracking</span>
                <div class="toggle-switch active" id="trackingToggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="search-container">
    <div class="search-wrapper">
        <input type="text" class="search-input" id="searchInput" placeholder="Search maps...">
        <select class="search-type-dropdown" id="searchTypeDropdown">
            <option value="all">All</option>
            <option value="mapname">Map Name</option>
            <option value="artist">Artist</option>
            <option value="mapper">Mapper</option>
            <option value="link">GitHub Link</option>
        </select>
    </div>
    
    <div class="filter-bar">
        <button class="filter-btn" id="difficultyFilterBtn">Difficulty</button>
        <button class="filter-btn" id="patternsFilterBtn">Patterns</button>
        <button class="filter-btn" id="rangeFilterBtn">Range Filters</button>
        <button class="filter-btn" id="otherFilterBtn">Other Filters</button>
    </div>
</div>

<div class="active-filters" id="activeFilters">
    <span class="active-filters-label">Active Filters:</span>
    <span id="activeFiltersContent" style="color: rgba(255, 255, 255, 0.5); font-size: 0.85em;">None</span>
</div>

<div class="sort-controls" style="max-width: 1800px; margin: 0 auto 30px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
    <span class="sort-label">Sort by:</span>
    <select class="sort-select" id="primarySort">
        <option value="difficulty-asc">Difficulty: Easy ‚Üí Hard</option>
        <option value="difficulty-desc">Difficulty: Hard ‚Üí Easy</option>
        <option value="star-asc">Star Rating: Low ‚Üí High</option>
        <option value="star-desc">Star Rating: High ‚Üí Low</option>
    </select>
    <span class="sort-label">Then by:</span>
    <select class="sort-select" id="secondarySort">
        <option value="none">None</option>
        <option value="star-desc">Star Rating: High ‚Üí Low</option>
        <option value="star-asc">Star Rating: Low ‚Üí High</option>
        <option value="difficulty-asc">Difficulty: Easy ‚Üí Hard</option>
        <option value="difficulty-desc">Difficulty: Hard ‚Üí Easy</option>
    </select>
</div>

<div class="loading-spinner" id="loadingSpinner"></div>
<div class="map-grid" id="mapGrid"></div>

<div class="load-more-container">
    <button class="load-more-btn" id="loadMoreBtn">Load More Maps</button>
</div>

<div class="popup" id="popup"></div>

<div class="cookie-consent" id="cookieConsent">
    <div class="cookie-content">
        <div class="cookie-text">
            <h3>üç™ We Use Cookies</h3>
            <p>We use cookies and similar technologies to enhance your experience and save your preferences (like favorites). By continuing to use this site, you accept our use of cookies. <a href="https://faworee.com/PrivacyPolicy" target="_blank" rel="noopener">Learn more in our Privacy Policy</a>.</p>
        </div>
        <div class="cookie-actions">
            <button class="cookie-btn cookie-decline" id="cookieDecline">Decline</button>
            <button class="cookie-btn cookie-accept" id="cookieAccept">Accept</button>
        </div>
    </div>
</div>

<div class="modal" id="difficultyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Difficulty Filter</h2>
            <button class="close-btn" onclick="closeModal('difficultyModal')">√ó</button>
        </div>
        <div class="filter-section">
            <div class="filter-options" id="difficultyOptions">
                <button class="filter-option" data-difficulty="Easy">Easy</button>
                <button class="filter-option" data-difficulty="Medium">Medium</button>
                <button class="filter-option" data-difficulty="Hard">Hard</button>
                <button class="filter-option" data-difficulty="Logic">Logic</button>
                <button class="filter-option" data-difficulty="Brrrr">Brrrr</button>
                <button class="filter-option" data-difficulty="Tasukete">Tasukete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="patternsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Pattern Filter</h2>
            <button class="close-btn" onclick="closeModal('patternsModal')">√ó</button>
        </div>
        <div class="filter-section">
            <div class="filter-options" id="patternOptions">
                <button class="filter-option" data-pattern="Streams">Streams</button>
                <button class="filter-option" data-pattern="Walls">Walls</button>
                <button class="filter-option" data-pattern="Tech">Tech</button>
                <button class="filter-option" data-pattern="Jumps">Jumps</button>
                <button class="filter-option" data-pattern="Quantum">Quantum</button>
                <button class="filter-option" data-pattern="Unconventional">Unconventional</button>
                <button class="filter-option" data-pattern="Bursts">Bursts</button>
                <button class="filter-option" data-pattern="Timing">Timing</button>
                <button class="filter-option" data-pattern="Stacks">Stacks</button>
                <button class="filter-option" data-pattern="Spins">Spins</button>
                <button class="filter-option" data-pattern="Slides">Slides</button>
                <button class="filter-option" data-pattern="Vibros">Vibros</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="rangeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Range Filters</h2>
            <button class="close-btn" onclick="closeModal('rangeModal')">√ó</button>
        </div>
        <div class="filter-section">
            <h3>Duration</h3>
            <div class="range-slider">
                <div class="slider-inputs">
                    <input type="text" class="slider-input" id="durationMin" placeholder="0:00">
                    <input type="text" class="slider-input" id="durationMax" placeholder="10:00">
                </div>
                <div class="dual-range-slider">
                    <div class="slider-track" id="durationTrack"></div>
                    <div class="slider-thumb" id="durationMinThumb"></div>
                    <div class="slider-thumb" id="durationMaxThumb"></div>
                </div>
            </div>
        </div>
        <div class="filter-section">
            <h3>Note Count</h3>
            <div class="range-slider">
                <div class="slider-inputs">
                    <input type="number" class="slider-input" id="notesMin" placeholder="0">
                    <input type="number" class="slider-input" id="notesMax" placeholder="10000">
                </div>
                <div class="dual-range-slider">
                    <div class="slider-track" id="notesTrack"></div>
                    <div class="slider-thumb" id="notesMinThumb"></div>
                    <div class="slider-thumb" id="notesMaxThumb"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="otherModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Other Filters</h2>
            <button class="close-btn" onclick="closeModal('otherModal')">√ó</button>
        </div>
        <div class="filter-section">
            <div class="filter-options">
                <button class="filter-option" id="newMapsFilter">New Maps Only</button>
                <button class="filter-option" id="favoritesFilter">Favorites Only</button>
            </div>
        </div>
        <div class="filter-section">
            <h3>APM Music</h3>
            <div class="filter-options">
                <button class="filter-option active" data-apm="all">All Maps</button>
                <button class="filter-option" data-apm="only">APM Only</button>
                <button class="filter-option" data-apm="none">No APM</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="changelogModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Update Log</h2>
            <button class="close-btn" onclick="closeModal('changelogModal')">√ó</button>
        </div>
        <div class="changelog-content" id="changelogContent">
            <p style="text-align: center; color: #666;">Loading changelog...</p>
        </div>
    </div>
</div>

<div class="modal secret-share-modal" id="secretShareModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üéâ Secret Found!</h2>
            <button class="close-btn" onclick="closeModal('secretShareModal')">√ó</button>
        </div>
        <div style="margin: 20px 0; text-align: center;">
            <p style="font-size: 1.1em; margin-bottom: 15px;">Would you like to share that you found the Nate10993 secret?</p>
        </div>
        <div class="secret-share-buttons">
            <button class="secret-share-btn secret-share-yes" id="shareYesBtn">Yes</button>
            <button class="secret-share-btn secret-share-no" id="shareNoBtn">No</button>
        </div>
        <div class="username-input-container" id="usernameContainer" style="display: none;">
            <p style="margin-bottom: 15px; text-align: center;">Share your information:</p>
            <input type="text" class="username-input" id="usernameInput" placeholder="Your username (required)..." style="margin-bottom: 10px;">
            <input type="text" class="username-input" id="additionalInfoInput" placeholder="Additional info (optional)...">
            <button class="username-submit-btn" id="usernameSubmitBtn">Submit</button>
        </div>
    </div>
</div>

<div class="modal start-from-modal" id="startFromModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Start From</h2>
            <button class="close-btn" onclick="closeModal('startFromModal')">√ó</button>
        </div>
        <div class="filter-section">
            <p style="margin-bottom: 15px; text-align: center; color: rgba(255, 255, 255, 0.8);">Select the start time for this map:</p>
            <div class="range-slider">
                <div class="slider-inputs">
                    <input type="text" class="slider-input" id="startTimeInput" placeholder="0:00" readonly>
                    <input type="text" class="slider-input" id="mapLengthDisplay" placeholder="0:00" readonly>
                </div>
                <div class="dual-range-slider">
                    <div class="slider-track" id="startTimeTrack" style="left: 0%; width: 100%;"></div>
                    <div class="slider-thumb" id="startTimeThumb"></div>
                </div>
            </div>
            <button class="start-from-apply" id="applyStartFromBtn">Apply & Copy Modified Map</button>
        </div>
    </div>
</div>

<script>
(function() {
    const WORKER_URL = 'https://logs-faworeee.faworeee.workers.dev/';
    let userFingerprint = null;
    let trackingEnabled = true;
    
    function init() {
        userFingerprint = generateFingerprint();
        loadTrackingPreference();
    }
    
    function loadTrackingPreference() {
        try {
            const saved = localStorage.getItem('mapCopyTrackingEnabled');
            if (saved !== null) {
                trackingEnabled = saved === 'true';
                updateTrackingToggleUI();
            }
        } catch (e) {}
    }
    
    function saveTrackingPreference() {
        try {
            localStorage.setItem('mapCopyTrackingEnabled', trackingEnabled.toString());
        } catch (e) {}
    }
    
    function updateTrackingToggleUI() {
        const toggle = document.getElementById('trackingToggle');
        if (toggle) {
            if (trackingEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }
    }
    
    function generateFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('fp', 2, 2);
        const canvasData = canvas.toDataURL();
        
        const components = [
            canvasData.substring(0, 50),
            screen.width + 'x' + screen.height + 'x' + screen.colorDepth,
            Intl.DateTimeFormat().resolvedOptions().timeZone,
            navigator.language,
            navigator.platform,
            navigator.hardwareConcurrency || 'u',
            navigator.deviceMemory || 'u',
            navigator.maxTouchPoints || 0,
            new Date().getTimezoneOffset(),
            screen.availWidth + 'x' + screen.availHeight
        ];
        
        const fingerprint = btoa(JSON.stringify(components)).substring(0, 50);
        return fingerprint + '-' + Date.now();
    }
    
    async function reportMapCopy(mapName, artist, mapper, copyType = 'link') {
        if (!trackingEnabled) return { success: true, tracking: false };
        
        try {
            const response = await fetch(WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'map-copy',
                    mapName: mapName,
                    artist: artist,
                    mapper: mapper,
                    copyType: copyType,
                    fingerprint: userFingerprint
                })
            });
            
            const result = await response.json();
            return result;
        } catch (error) {
            return { success: false };
        }
    }
    
    window.errorReporter = {
        reportMapCopy,
        isTrackingEnabled: () => trackingEnabled,
        setTrackingEnabled: (enabled) => {
            trackingEnabled = enabled;
            saveTrackingPreference();
            updateTrackingToggleUI();
        }
    };
    
    init();
})();

(function() {
    const GITHUB_IMAGES_BASE = 'https://raw.githubusercontent.com/faworee/Secret/main/Nate/';
    const WORKER_URL = 'https://logs-faworeee.faworeee.workers.dev/';
    let IMAGE_FILES = [];
    let confettiActive = false;
    let imagesFetched = false;
    let secretFound = false;
    let pendingLocationData = null;
    
    async function fetchImageList() {
        if (imagesFetched && IMAGE_FILES.length > 0) return;
        try {
            const response = await fetch('https://api.github.com/repos/faworee/Secret/contents/Nate');
            const files = await response.json();
            IMAGE_FILES = files
                .filter(file => /\.(png|jpg|jpeg|gif|webp)$/i.test(file.name))
                .map(file => file.name);
            imagesFetched = true;
        } catch (error) {
            IMAGE_FILES = ['default.png'];
        }
    }
    
    async function getCountryFromIP() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                country: data.country_name || 'Unknown',
                countryCode: data.country_code || 'XX',
                region: data.region || 'Unknown'
            };
        } catch (error) {
            return {
                country: 'Unknown',
                countryCode: 'XX',
                region: 'Unknown'
            };
        }
    }
    
    async function sendSecretFoundWebhook(locationData, username = null, additionalInfo = null) {
    try {
        console.log('Sending to worker:', { locationData, username, additionalInfo });
        const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'secret-found',
                country: locationData.country,
                countryCode: locationData.countryCode,
                region: locationData.region,
                username: username,
                additionalInfo: additionalInfo
            })
        });
        console.log('Worker response:', response.status);
    } catch (error) {
        console.error('Worker error:', error);
    }
}
    
    function showSecretFoundMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.5s ease-out;
            text-align: center;
        `;
        messageDiv.textContent = 'üéâ You found the Nate10993 secret! üéâ';
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.style.transition = 'opacity 1s';
            messageDiv.style.opacity = '0';
            setTimeout(() => messageDiv.remove(), 1000);
        }, 5000);
    }
    
    function getRandomImageUrl() {
        const randomIndex = Math.floor(Math.random() * IMAGE_FILES.length);
        return GITHUB_IMAGES_BASE + IMAGE_FILES[randomIndex];
    }
    
    function createConfettiParticle() {
        const confetti = document.createElement('img');
        confetti.src = getRandomImageUrl();
        confetti.className = 'nate-confetti';
        const startX = Math.random() * window.innerWidth;
        confetti.style.left = startX + 'px';
        confetti.style.top = '-100px';
        const size = Math.random() * 30 + 30;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        const rotation = Math.random() * 360;
        confetti.style.transform = `rotate(${rotation}deg)`;
        const duration = Math.random() * 4 + 2;
        confetti.style.animationDuration = duration + 's';
        const drift = (Math.random() - 0.5) * 300;
        confetti.style.setProperty('--drift', drift + 'px');
        const rotationSpeed = Math.random() * 720 + 360;
        confetti.style.setProperty('--rotation', rotationSpeed + 'deg');
        document.body.appendChild(confetti);
        setTimeout(() => {
            confetti.remove();
        }, duration * 1000);
        return confetti;
    }
    
    async function triggerConfetti() {
        if (confettiActive) return;
        confettiActive = true;
        await fetchImageList();
        if (IMAGE_FILES.length === 0) {
            confettiActive = false;
            return;
        }
        
        showSecretFoundMessage();
        
        if (!secretFound) {
            secretFound = true;
            pendingLocationData = await getCountryFromIP();
            document.getElementById('secretShareModal').classList.add('show');
        }
        
        const quality = document.body.classList.contains('low-quality') ? 'low' : 'high';
        const particleCount = quality === 'low' ? 10 : 50;
        const spawnInterval = quality === 'low' ? 200 : 50;
        for (let i = 0; i < particleCount; i++) {
            setTimeout(() => {
                createConfettiParticle();
            }, i * spawnInterval);
        }
        setTimeout(() => {
            confettiActive = false;
        }, 8000);
    }
    
    window.triggerNateConfetti = triggerConfetti;
    
    function init() {
        fetchImageList();
        
        document.addEventListener('click', (e) => {
            const clickedElement = e.target;
            const parentElement = clickedElement.closest('.map-card, a, button');
            if (parentElement) {
                const textContent = (parentElement.textContent || '') + 
                                  (clickedElement.textContent || '') +
                                  (parentElement.getAttribute('title') || '') +
                                  (clickedElement.getAttribute('title') || '');
                if (textContent.toLowerCase().includes('nate10993')) {
                    triggerConfetti();
                }
            }
        });
        
        document.getElementById('shareYesBtn').addEventListener('click', () => {
            document.getElementById('usernameContainer').style.display = 'block';
        });
        
       document.getElementById('shareNoBtn').addEventListener('click', async () => {
    closeModal('secretShareModal');
});
        
        document.getElementById('usernameSubmitBtn').addEventListener('click', async () => {
    const username = document.getElementById('usernameInput').value.trim();
    const additionalInfo = document.getElementById('additionalInfoInput').value.trim();
    
    if (username && pendingLocationData) {
        await sendSecretFoundWebhook(pendingLocationData, username, additionalInfo);
        pendingLocationData = null;
        showPopup('Thank you for sharing! üéâ');
        closeModal('secretShareModal');
        document.getElementById('usernameInput').value = '';
        document.getElementById('additionalInfoInput').value = '';
        document.getElementById('usernameContainer').style.display = 'none';
    } else if (!username) {
        showPopup('Please enter a username!', true);
    }
});
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
function checkCookieConsent() {
    const consent = localStorage.getItem('cookieConsent');
    if (!consent) {
        document.getElementById('cookieConsent').classList.add('show');
    }
}

document.getElementById('cookieAccept').addEventListener('click', () => {
    localStorage.setItem('cookieConsent', 'accepted');
    document.getElementById('cookieConsent').classList.remove('show');
    showPopup('Thank you! Your preferences will be saved.');
});

document.getElementById('cookieDecline').addEventListener('click', () => {
    localStorage.setItem('cookieConsent', 'declined');
    document.getElementById('cookieConsent').classList.remove('show');
    showPopup('Cookies declined. Some features may be limited.', true);
    document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
});

document.getElementById('trackingToggle').addEventListener('click', function() {
    if (window.errorReporter) {
        const newState = !window.errorReporter.isTrackingEnabled();
        window.errorReporter.setTrackingEnabled(newState);
        showPopup(newState ? 'Map Copy Tracking Enabled' : 'Map Copy Tracking Disabled');
    }
});

class FavoritesManager {
    constructor() {
        this.favorites = new Set();
        this.loadFavorites();
    }

    loadFavorites() {
        try {
            const saved = document.cookie
                .split('; ')
                .find(row => row.startsWith('soundSpaceFavorites='));
            if (saved) {
                const data = JSON.parse(decodeURIComponent(saved.split('=')[1]));
                this.favorites = new Set(data);
            }
        } catch (e) {
            console.warn('Failed to load favorites:', e);
        }
    }

    saveFavorites() {
        try {
            const data = JSON.stringify([...this.favorites]);
            const expires = new Date();
            expires.setFullYear(expires.getFullYear() + 10);
            document.cookie = `soundSpaceFavorites=${encodeURIComponent(data)}; expires=${expires.toUTCString()}; path=/`;
        } catch (e) {
            console.warn('Failed to save favorites:', e);
        }
    }

    getMapId(map) {
        return `${map.mapName}${map.artist}${map.mapper}${map.noteCount || 0}`;
    }

    isFavorite(map) {
        return this.favorites.has(this.getMapId(map));
    }

    toggleFavorite(map) {
        const id = this.getMapId(map);
        if (this.favorites.has(id)) {
            this.favorites.delete(id);
        } else {
            this.favorites.add(id);
        }
        this.saveFavorites();
        return this.favorites.has(id);
    }

    getFavoriteCount() {
        return this.favorites.size;
    }
}

const favoritesManager = new FavoritesManager();
let isLowQualityMode = false;
const difficultyOrder = ["Easy", "Medium", "Hard", "Logic", "Brrrr", "Tasukete"];
const difficultyEmojis = {
    "Easy": "üü©",
    "Medium": "üü®", 
    "Hard": "üü•",
    "Logic": "üü™",
    "Brrrr": "‚¨ú",
    "Tasukete": "üü¶"
};
let currentSortMode = 'difficulty-asc';
let secondarySortMode = 'none';
let maps = [];
let filteredMaps = [];
let selectedDifficulties = [];
let selectedPatterns = [];
let apmFilter = "all";
let showNewMapsOnly = false;
let showFavoritesOnly = false;
let currentDisplayCount = 500;
const LOAD_BATCH_SIZE = 250;
let isLoading = false;
let durationRange = { min: 0, max: 600000 };
let notesRange = { min: 0, max: 20000 };
let currentDurationRange = { min: 0, max: 600000 };
let currentNotesRange = { min: 0, max: 20000 };
let currentStartFromMap = null;

const searchInput = document.getElementById('searchInput');
const mapGrid = document.getElementById('mapGrid');
const popup = document.getElementById('popup');
const loadingSpinner = document.getElementById('loadingSpinner');
const loadMoreBtn = document.getElementById('loadMoreBtn');
const menuToggle = document.getElementById('menuToggle');
const headerMenu = document.getElementById('headerMenu');
const randomMapBtn = document.getElementById('randomMapBtn');
const updateLogBtn = document.getElementById('updateLogBtn');
const qualityToggle = document.getElementById('qualityToggle');
const durationMinThumb = document.getElementById('durationMinThumb');
const durationMaxThumb = document.getElementById('durationMaxThumb');
const durationMinInput = document.getElementById('durationMin');
const durationMaxInput = document.getElementById('durationMax');
const durationTrack = document.getElementById('durationTrack');
const notesMinThumb = document.getElementById('notesMinThumb');
const notesMaxThumb = document.getElementById('notesMaxThumb');
const notesMinInput = document.getElementById('notesMin');
const notesMaxInput = document.getElementById('notesMax');
const notesTrack = document.getElementById('notesTrack');

menuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    headerMenu.classList.toggle('show');
});

document.addEventListener('click', (e) => {
    if (!menuToggle.contains(e.target) && !headerMenu.contains(e.target)) {
        headerMenu.classList.remove('show');
    }
});

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

document.getElementById('difficultyFilterBtn').addEventListener('click', () => {
    document.getElementById('difficultyModal').classList.add('show');
});

document.getElementById('patternsFilterBtn').addEventListener('click', () => {
    document.getElementById('patternsModal').classList.add('show');
});

document.getElementById('rangeFilterBtn').addEventListener('click', () => {
    document.getElementById('rangeModal').classList.add('show');
});

document.getElementById('otherFilterBtn').addEventListener('click', () => {
    document.getElementById('otherModal').classList.add('show');
});

updateLogBtn.addEventListener('click', () => {
    document.getElementById('changelogModal').classList.add('show');
    loadChangelog();
});

document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('show');
        }
    });
});

document.querySelectorAll('#difficultyOptions .filter-option').forEach(btn => {
    btn.addEventListener('click', () => {
        const difficulty = btn.dataset.difficulty;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
            if (!selectedDifficulties.includes(difficulty)) {
                selectedDifficulties.push(difficulty);
            }
        } else {
            selectedDifficulties = selectedDifficulties.filter(d => d !== difficulty);
        }
        filterAndRenderMaps();
    });
});

document.querySelectorAll('#patternOptions .filter-option').forEach(btn => {
    btn.addEventListener('click', () => {
        const pattern = btn.dataset.pattern;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) {
            if (!selectedPatterns.includes(pattern)) {
                selectedPatterns.push(pattern);
            }
        } else {
            selectedPatterns = selectedPatterns.filter(p => p !== pattern);
        }
        filterAndRenderMaps();
    });
});

document.querySelectorAll('[data-apm]').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('[data-apm]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        apmFilter = btn.dataset.apm;
        filterAndRenderMaps();
    });
});

document.getElementById('newMapsFilter').addEventListener('click', function() {
    this.classList.toggle('active');
    showNewMapsOnly = this.classList.contains('active');
    filterAndRenderMaps();
});

document.getElementById('favoritesFilter').addEventListener('click', function() {
    this.classList.toggle('active');
    showFavoritesOnly = this.classList.contains('active');
    filterAndRenderMaps();
});

qualityToggle.addEventListener('click', () => {
    isLowQualityMode = !isLowQualityMode;
    document.body.classList.toggle('low-quality', isLowQualityMode);
    qualityToggle.textContent = isLowQualityMode ? 'High Quality Mode' : 'Low Quality Mode';
    try {
        localStorage.setItem('soundSpaceLowQuality', isLowQualityMode.toString());
    } catch (e) {}
    if (maps.length > 0) {
        renderMaps();
    }
});

try {
    const savedPreference = localStorage.getItem('soundSpaceLowQuality');
    if (savedPreference === 'true') {
        qualityToggle.click();
    }
} catch (e) {}

randomMapBtn.addEventListener('click', () => {
    if (filteredMaps.length === 0) {
        showPopup('No maps match your current filters!', true);
        return;
    }
    const randomMap = filteredMaps[Math.floor(Math.random() * filteredMaps.length)];
    copyToClipboard(randomMap.link, 'Random map link copied!', randomMap, 'link');
});

document.getElementById('primarySort').addEventListener('change', (e) => {
    currentSortMode = e.target.value;
    filterAndRenderMaps();
});

document.getElementById('secondarySort').addEventListener('change', (e) => {
    secondarySortMode = e.target.value;
    filterAndRenderMaps();
});

function initRangeSliders() {
    let isDraggingDuration = false;
    let currentDurationThumb = null;
    
    function updateDurationSlider() {
        const minPercent = (currentDurationRange.min / durationRange.max) * 100;
        const maxPercent = (currentDurationRange.max / durationRange.max) * 100;
        
        durationMinThumb.style.left = minPercent + '%';
        durationMaxThumb.style.left = maxPercent + '%';
        durationTrack.style.left = minPercent + '%';
        durationTrack.style.width = (maxPercent - minPercent) + '%';
        
        durationMinInput.value = formatDuration(currentDurationRange.min);
        durationMaxInput.value = formatDuration(currentDurationRange.max);
    }
    
    function handleDurationMouseDown(e, thumb) {
        e.preventDefault();
        isDraggingDuration = true;
        currentDurationThumb = thumb;
        thumb.classList.add('active');
        document.addEventListener('mousemove', handleDurationMouseMove);
        document.addEventListener('mouseup', handleDurationMouseUp);
    }
    
    function handleDurationMouseMove(e) {
        if (!isDraggingDuration || !currentDurationThumb) return;
        e.preventDefault();
        
        const slider = currentDurationThumb.parentElement;
        const rect = slider.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        const value = (percent / 100) * durationRange.max;
        
        if (currentDurationThumb === durationMinThumb) {
            currentDurationRange.min = Math.max(0, Math.min(value, currentDurationRange.max - 1000));
        } else {
            currentDurationRange.max = Math.min(durationRange.max, Math.max(value, currentDurationRange.min + 1000));
        }
        
        updateDurationSlider();
        filterAndRenderMaps();
    }
    
    function handleDurationMouseUp() {
        if (isDraggingDuration && currentDurationThumb) {
            currentDurationThumb.classList.remove('active');
            isDraggingDuration = false;
            currentDurationThumb = null;
            document.removeEventListener('mousemove', handleDurationMouseMove);
            document.removeEventListener('mouseup', handleDurationMouseUp);
        }
    }
    
    durationMinThumb.addEventListener('mousedown', (e) => handleDurationMouseDown(e, durationMinThumb));
    durationMaxThumb.addEventListener('mousedown', (e) => handleDurationMouseDown(e, durationMaxThumb));
    
    let isDraggingNotes = false;
    let currentNotesThumb = null;
    
    function updateNotesSlider() {
        const minPercent = (currentNotesRange.min / notesRange.max) * 100;
        const maxPercent = (currentNotesRange.max / notesRange.max) * 100;
        
        notesMinThumb.style.left = minPercent + '%';
        notesMaxThumb.style.left = maxPercent + '%';
        notesTrack.style.left = minPercent + '%';
        notesTrack.style.width = (maxPercent - minPercent) + '%';
        
        notesMinInput.value = Math.round(currentNotesRange.min);
        notesMaxInput.value = Math.round(currentNotesRange.max);
    }
    
    function handleNotesMouseDown(e, thumb) {
        e.preventDefault();
        isDraggingNotes = true;
        currentNotesThumb = thumb;
        thumb.classList.add('active');
        document.addEventListener('mousemove', handleNotesMouseMove);
        document.addEventListener('mouseup', handleNotesMouseUp);
    }
    
    function handleNotesMouseMove(e) {
        if (!isDraggingNotes || !currentNotesThumb) return;
        e.preventDefault();
        
        const slider = currentNotesThumb.parentElement;
        const rect = slider.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        const value = (percent / 100) * notesRange.max;
        
        if (currentNotesThumb === notesMinThumb) {
            currentNotesRange.min = Math.max(0, Math.min(value, currentNotesRange.max - 10));
        } else {
            currentNotesRange.max = Math.min(notesRange.max, Math.max(value, currentNotesRange.min + 10));
        }
        
        updateNotesSlider();
        filterAndRenderMaps();
    }
    
    function handleNotesMouseUp() {
        if (isDraggingNotes && currentNotesThumb) {
            currentNotesThumb.classList.remove('active');
            isDraggingNotes = false;
            currentNotesThumb = null;
            document.removeEventListener('mousemove', handleNotesMouseMove);
            document.removeEventListener('mouseup', handleNotesMouseUp);
        }
    }
    
    notesMinThumb.addEventListener('mousedown', (e) => handleNotesMouseDown(e, notesMinThumb));
    notesMaxThumb.addEventListener('mousedown', (e) => handleNotesMouseDown(e, notesMaxThumb));
    
    updateDurationSlider();
    updateNotesSlider();
}

function updateActiveFiltersDisplay() {
    const content = document.getElementById('activeFiltersContent');
    const filters = [];
    
    if (selectedDifficulties.length > 0) {
        filters.push(`Difficulty: ${selectedDifficulties.join(', ')}`);
    }
    if (selectedPatterns.length > 0) {
        filters.push(`Patterns: ${selectedPatterns.join(', ')}`);
    }
    if (currentDurationRange.min > 0 || currentDurationRange.max < durationRange.max) {
        filters.push(`Duration: ${formatDuration(currentDurationRange.min)} - ${formatDuration(currentDurationRange.max)}`);
    }
    if (currentNotesRange.min > 0 || currentNotesRange.max < notesRange.max) {
        filters.push(`Notes: ${Math.round(currentNotesRange.min)} - ${Math.round(currentNotesRange.max)}`);
    }
    if (apmFilter !== 'all') {
        filters.push(`APM: ${apmFilter === 'only' ? 'Only APM' : 'No APM'}`);
    }
    if (showNewMapsOnly) {
        filters.push('New Maps Only');
    }
    if (showFavoritesOnly) {
        filters.push('Favorites Only');
    }
    
    content.textContent = filters.length > 0 ? filters.join(' ‚Ä¢ ') : 'None';
}

let searchTimeout;
searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    
    const searchValue = searchInput.value.toLowerCase();
    if (searchValue.includes('nate10993')) {
        if (window.triggerNateConfetti) {
            window.triggerNateConfetti();
        }
    }
    
    searchTimeout = setTimeout(() => {
        currentDisplayCount = LOAD_BATCH_SIZE;
        filterAndRenderMaps();
    }, 300);
});

loadMoreBtn.addEventListener('click', () => {
    if (!isLoading) {
        loadMoreMaps();
    }
});

function loadMoreMaps() {
    if (isLoading || currentDisplayCount >= filteredMaps.length) return;
    
    isLoading = true;
    loadingSpinner.style.display = 'block';
    loadMoreBtn.disabled = true;
    loadMoreBtn.textContent = 'Loading...';
    
    setTimeout(() => {
        const previousCount = currentDisplayCount;
        currentDisplayCount = Math.min(currentDisplayCount + LOAD_BATCH_SIZE, filteredMaps.length);
        
        const fragment = document.createDocumentFragment();
        for (let i = previousCount; i < currentDisplayCount; i++) {
            const card = createMapCard(filteredMaps[i]);
            fragment.appendChild(card);
        }
        mapGrid.appendChild(fragment);
        
        updateLoadMoreButton();
        isLoading = false;
        loadingSpinner.style.display = 'none';
    }, 100);
}

function updateLoadMoreButton() {
    const remainingMaps = filteredMaps.length - currentDisplayCount;
    
    if (remainingMaps <= 0) {
        loadMoreBtn.style.display = 'none';
    } else {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = `Load ${Math.min(LOAD_BATCH_SIZE, remainingMaps)} More Maps`;
    }
}

function showPopup(message, isError = false) {
    popup.textContent = message;
    popup.style.backgroundColor = isError ? "#dc3545" : "#28a745";
    popup.style.display = "block";
    setTimeout(() => {
        popup.style.display = "none";
    }, 2500);
}

function formatDuration(milliseconds) {
    if (milliseconds <= 0 || isNaN(milliseconds)) return "0:00";
    const totalSeconds = Math.floor(milliseconds / 1000);
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function isApmMap(artist) {
    return artist.toLowerCase().includes('apm music');
}

async function copyToClipboard(text, message, map, copyType) {
    try {
        await navigator.clipboard.writeText(text);
        showPopup(message);
        
        if (window.errorReporter && window.errorReporter.reportMapCopy && map) {
            window.errorReporter.reportMapCopy(
                map.mapName, 
                map.artist, 
                map.mapper, 
                copyType
            );
        }
    } catch (error) {
        showPopup('Failed to copy!', true);
        console.error(error);
    }
}

window.toggleFavorite = function(button, event) {
    event.stopPropagation();
    const mapData = JSON.parse(button.getAttribute('data-map').replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
    const isFav = favoritesManager.toggleFavorite(mapData);
    button.classList.toggle('favorited', isFav);
    showPopup(isFav ? 'Added to favorites!' : 'Removed from favorites!');
    
    if (showFavoritesOnly) {
        filterAndRenderMaps();
    }
};

window.openStartFrom = async function(link) {
    try {
        const dropdown = event.target.closest('.more-actions-dropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
        
        const rawLink = link.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        const response = await fetch(rawLink);
        if (!response.ok) throw new Error('Failed to fetch map');
        const mapContent = await response.text();
        
        const firstCommaIndex = mapContent.indexOf(',');
        if (firstCommaIndex === -1) {
            showPopup('Invalid map format!', true);
            return;
        }
        
        const mapId = mapContent.substring(0, firstCommaIndex);
        const notesData = mapContent.substring(firstCommaIndex + 1);
        const notes = notesData.split(',').map(note => {
            const parts = note.split('|');
            if (parts.length >= 3) {
                return {
                    x: parts[0],
                    y: parts[1],
                    ms: parseFloat(parts[2]) || 0,
                    raw: note
                };
            }
            return null;
        }).filter(n => n !== null);
        
        if (notes.length === 0) {
            showPopup('No notes found in map!', true);
            return;
        }
        
        const minTime = Math.min(...notes.map(n => n.ms));
        const maxTime = Math.max(...notes.map(n => n.ms));
        const duration = maxTime - minTime;
        
        currentStartFromMap = {
            mapId: mapId,
            notes: notes,
            minTime: minTime,
            maxTime: maxTime,
            duration: duration
        };
        
        initStartFromSlider();
        document.getElementById('startFromModal').classList.add('show');
    } catch (error) {
        showPopup('Failed to load map!', true);
    }
};

function initStartFromSlider() {
    if (!currentStartFromMap) return;
    
    const startTimeThumb = document.getElementById('startTimeThumb');
    const startTimeInput = document.getElementById('startTimeInput');
    const mapLengthDisplay = document.getElementById('mapLengthDisplay');
    const startTimeTrack = document.getElementById('startTimeTrack');
    
    let currentStartTime = currentStartFromMap.minTime;
    
    mapLengthDisplay.value = formatDuration(currentStartFromMap.duration);
    startTimeInput.value = formatDuration(0);
    
    let isDragging = false;
    
    function updateSlider() {
        const percent = ((currentStartTime - currentStartFromMap.minTime) / currentStartFromMap.duration) * 100;
        startTimeThumb.style.left = percent + '%';
        startTimeTrack.style.left = '0%';
        startTimeTrack.style.width = percent + '%';
        startTimeInput.value = formatDuration(currentStartTime - currentStartFromMap.minTime);
    }
    
    function handleMouseDown(e) {
        e.preventDefault();
        isDragging = true;
        startTimeThumb.classList.add('active');
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
    
    function handleMouseMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        
        const slider = startTimeThumb.parentElement;
        const rect = slider.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        currentStartTime = currentStartFromMap.minTime + (percent / 100) * currentStartFromMap.duration;
        
        updateSlider();
    }
    
    function handleMouseUp() {
        if (isDragging) {
            startTimeThumb.classList.remove('active');
            isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }
    }
    
    startTimeThumb.removeEventListener('mousedown', startTimeThumb._mouseDownHandler);
    startTimeThumb._mouseDownHandler = handleMouseDown;
    startTimeThumb.addEventListener('mousedown', handleMouseDown);
    
        document.getElementById('applyStartFromBtn').onclick = async function() {
        const filteredNotes = currentStartFromMap.notes.filter(note => note.ms >= currentStartTime);
        
        if (filteredNotes.length === 0) {
            showPopup('No notes after selected start time!', true);
            return;
        }
        
        const notesString = filteredNotes.map(n => n.raw).join(',');
        const modifiedMap = currentStartFromMap.mapId + ',' + notesString;
        
        const card = document.querySelector('.map-card');
        const favoriteBtn = card ? card.querySelector('.favorite-btn') : null;
        let mapData = { mapName: 'Unknown', artist: 'Unknown', mapper: 'Unknown' };
        
        if (favoriteBtn) {
            try {
                mapData = JSON.parse(favoriteBtn.getAttribute('data-map').replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
            } catch (e) {
                console.warn('Could not parse map data:', e);
            }
        }
        
        try {
            await navigator.clipboard.writeText(modifiedMap);
            showPopup('Modified map copied!');
            
            if (window.errorReporter && window.errorReporter.reportMapCopy) {
                window.errorReporter.reportMapCopy(mapData.mapName, mapData.artist, mapData.mapper, 'start-from');
            }
            
            closeModal('startFromModal');
        } catch (error) {
            showPopup('Failed to copy modified map!', true);
        }
    };
    
    updateSlider();
}

function createMapCard(m) {
    const card = document.createElement('div');
    card.classList.add('map-card');
    let mapDifficulty = m.difficulty.toLowerCase();
    if (m.difficulty === "No Data") {
        mapDifficulty = "brrrr";
    }
    card.classList.add(mapDifficulty);
    
    let newTagHtml = '';
    if (m.isNew) {
        newTagHtml = '<div class="new-badge">NEW</div>';
    }

    const isFavorite = favoritesManager.isFavorite(m);
    const mapDataJSON = JSON.stringify(m).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const difficultyEmoji = difficultyEmojis[m.difficulty] || '‚¨ú';
    const difficultyName = m.difficulty || 'Unknown';
    
    const starRating = m.starRating !== null && m.starRating !== undefined ? 
        `‚òÖ ${parseFloat(m.starRating).toFixed(2)}` : '‚òÖ N/A';
    
    let statsHtml = '';
    if (!isLowQualityMode) {
        const durationText = (m.duration !== undefined && m.duration !== null) ? formatDuration(m.duration) : '--:--';
        const noteCountText = (m.noteCount !== undefined && m.noteCount !== null) ? m.noteCount.toLocaleString() : '----';
        statsHtml = `<div class="info-item"><img src="Clock1.png" alt="Duration" onerror="this.style.display='none'"> ${durationText} - <img src="Note.png" alt="Notes" onerror="this.style.display='none'"> ${noteCountText}</div>`;
    } else {
        statsHtml = `<div class="info-item" style="color: #888;">Stats disabled</div>`;
    }
    
    let patternsHtml = '';
    if (m.patterns && m.patterns.length > 0) {
        const patternList = m.patterns.map(p => p === "No Data" ? "No Pattern Data" : p).join(', ');
        patternsHtml = `
            <div class="patterns-display">
                <strong>Patterns:</strong>
                <span>${patternList}</span>
            </div>
        `;
    } else {
        patternsHtml = `
            <div class="patterns-display">
                <strong>Patterns:</strong>
                <span style="color: #888;">None</span>
            </div>
        `;
    }
    
    let infoHtml = '';
    if (m.info && m.info.trim() !== '') {
        infoHtml = `
            <div class="info-display">
                <strong>Info:</strong>
                <span>${m.info}</span>
            </div>
        `;
    } else {
        infoHtml = `
            <div class="info-display">
                <strong>Info:</strong>
                <span style="color: #888;">No Info Provided</span>
            </div>
        `;
    }

    card.innerHTML = `
        ${newTagHtml}
        <div class="card-header">
            <div class="star-rating">${starRating}</div>
            <button class="favorite-btn ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite(this, event)" data-map="${mapDataJSON}">
                <span class="heart-outline">‚ô°</span>
                <span class="heart-filled">‚ô•</span>
            </button>
        </div>
        <div class="card-content">
            <div class="map-title"><a href="${m.link}" target="_blank" rel="noopener">${m.mapName}</a></div>
            <div class="artist-name">${m.artist}</div>
            <div class="map-info">
                <div class="info-item">Mapper: ${m.mapper} - Difficulty: <span class="difficulty-emoji">${difficultyEmoji}<span class="difficulty-tooltip">${difficultyName}</span></span></div>
                ${statsHtml}
            </div>
            ${patternsHtml}
            ${infoHtml}
        </div>
        <div class="card-footer">
            <button class="action-btn" onclick="copyMapLink('${m.link.replace(/'/g, "\\'")}', this)">Copy Link</button>
            <button class="more-btn" onclick="toggleMoreActions(this)">‚ãÆ
                <div class="more-actions-dropdown">
                    <div class="dropdown-action" onclick="openStartFrom('${m.link.replace(/'/g, "\\'")}')">Start From</div>
                    <div class="dropdown-action" onclick="copyRawData('${m.link.replace(/'/g, "\\'")}')">Copy Raw</div>
                </div>
            </button>
        </div>
    `;
    return card;
}

window.copyMapLink = async function(link, button) {
    const card = button.closest('.map-card');
    const favoriteBtn = card.querySelector('.favorite-btn');
    let mapData = { mapName: 'Unknown', artist: 'Unknown', mapper: 'Unknown' };
    
    if (favoriteBtn) {
        try {
            mapData = JSON.parse(favoriteBtn.getAttribute('data-map').replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
        } catch (e) {
            console.warn('Could not parse map data:', e);
        }
    }
    
    try {
        await navigator.clipboard.writeText(link);
        button.textContent = 'Copied!';
        button.classList.add('copied');
        showPopup('Link copied!');
        
        const sound = document.getElementById('buttonSound');
        if (sound) {
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }
        
        setTimeout(() => {
            button.textContent = 'Copy Link';
            button.classList.remove('copied');
        }, 1000);
        
        if (window.errorReporter && window.errorReporter.reportMapCopy) {
            await window.errorReporter.reportMapCopy(mapData.mapName, mapData.artist, mapData.mapper, 'link');
        }
    } catch (err) {
        showPopup('Failed to copy link', true);
    }
};

window.copyRawData = async function(link) {
    try {
        const dropdown = event.target.closest('.more-actions-dropdown');
        const card = dropdown.closest('.map-card');
        const favoriteBtn = card.querySelector('.favorite-btn');
        let mapData = { mapName: 'Unknown', artist: 'Unknown', mapper: 'Unknown' };
        
        if (favoriteBtn) {
            try {
                mapData = JSON.parse(favoriteBtn.getAttribute('data-map').replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
            } catch (e) {
                console.warn('Could not parse map data:', e);
            }
        }
        
        const rawLink = link.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
        const response = await fetch(rawLink);
        if (!response.ok) throw new Error('Fetch failed');
        const rawContent = await response.text();
        await navigator.clipboard.writeText(rawContent);
        showPopup('Raw data copied!');
        
        if (window.errorReporter && window.errorReporter.reportMapCopy) {
            window.errorReporter.reportMapCopy(mapData.mapName, mapData.artist, mapData.mapper, 'raw');
        }
        
        const sound = document.getElementById('buttonSound');
        if (sound) {
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }
    } catch (error) {
        showPopup('Failed to copy raw data', true);
    }
};

window.toggleMoreActions = function(button) {
    const dropdown = button.querySelector('.more-actions-dropdown');
    dropdown.classList.toggle('show');
    
    document.querySelectorAll('.more-actions-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
    });
};

document.addEventListener('click', (e) => {
    if (!e.target.closest('.more-btn')) {
        document.querySelectorAll('.more-actions-dropdown').forEach(d => {
            d.classList.remove('show');
        });
    }
});

function filterAndRenderMaps() {
    const searchText = searchInput.value.toLowerCase();
    
    filteredMaps = maps.filter(m => {
        const matchesSearch = m.mapName.toLowerCase().includes(searchText) || 
                            m.artist.toLowerCase().includes(searchText) || 
                            m.mapper.toLowerCase().includes(searchText) ||
                            m.link.toLowerCase().includes(searchText);
        
        const matchesDifficulty = selectedDifficulties.length === 0 || selectedDifficulties.includes(m.difficulty);
        const matchesPatterns = selectedPatterns.length === 0 || selectedPatterns.every(pattern => m.patterns.includes(pattern));
        
        const isApm = isApmMap(m.artist);
        let matchesApm = true;
        if (apmFilter === "only") {
            matchesApm = isApm;
        } else if (apmFilter === "none") {
            matchesApm = !isApm;
        }

        const mapDuration = m.duration || 0;
        const mapNotes = m.noteCount || 0;
        
        const matchesDuration = mapDuration >= currentDurationRange.min && mapDuration <= currentDurationRange.max;
        const matchesNotes = mapNotes >= currentNotesRange.min && mapNotes <= currentNotesRange.max;
        
        const matchesNewFilter = !showNewMapsOnly || m.isNew;
        const matchesFavoritesFilter = !showFavoritesOnly || favoritesManager.isFavorite(m);

        return matchesSearch && matchesDifficulty && matchesPatterns && matchesApm && 
               matchesDuration && matchesNotes && matchesNewFilter && matchesFavoritesFilter;
    });

    filteredMaps.sort((a, b) => {
        const aFav = favoritesManager.isFavorite(a);
        const bFav = favoritesManager.isFavorite(b);
        if (aFav !== bFav) {
            return aFav ? -1 : 1;
        }
        
        if (currentSortMode === 'star-desc' || currentSortMode === 'star-asc') {
            const starA = a.starRating || 0;
            const starB = b.starRating || 0;
            const starComparison = currentSortMode === 'star-desc' ? starB - starA : starA - starB;
            if (starComparison !== 0) {
                return starComparison;
            }
        } else if (currentSortMode === 'difficulty-asc' || currentSortMode === 'difficulty-desc') {
            const diffA = difficultyOrder.indexOf(a.difficulty);
            const diffB = difficultyOrder.indexOf(b.difficulty);
            const diffComparison = currentSortMode === 'difficulty-asc' ? diffA - diffB : diffB - diffA;
            if (diffComparison !== 0) {
                return diffComparison;
            }
        }
        
        if (a.isNew !== b.isNew) {
            return a.isNew ? -1 : 1;
        }
        
        if (secondarySortMode !== 'none') {
            if (secondarySortMode === 'star-desc' || secondarySortMode === 'star-asc') {
                const starA = a.starRating || 0;
                const starB = b.starRating || 0;
                const starComparison = secondarySortMode === 'star-desc' ? starB - starA : starA - starB;
                if (starComparison !== 0) {
                    return starComparison;
                }
            } else if (secondarySortMode === 'difficulty-asc' || secondarySortMode === 'difficulty-desc') {
                const diffA = difficultyOrder.indexOf(a.difficulty);
                const diffB = difficultyOrder.indexOf(b.difficulty);
                const diffComparison = secondarySortMode === 'difficulty-asc' ? diffA - diffB : diffB - diffA;
                if (diffComparison !== 0) {
                    return diffComparison;
                }
            }
        }
        
        return 0;
    });
    
    updateActiveFiltersDisplay();
    renderMaps();
}

function renderMaps() {
    mapGrid.innerHTML = "";
    const itemsToShow = Math.min(filteredMaps.length, currentDisplayCount);
    const fragment = document.createDocumentFragment();
    
    for (let i = 0; i < itemsToShow; i++) {
        const card = createMapCard(filteredMaps[i]);
        fragment.appendChild(card);
    }
    
    mapGrid.appendChild(fragment);
    updateLoadMoreButton();
    loadingSpinner.style.display = 'none';
}

async function loadMapData() {
    try {
        loadingSpinner.style.display = 'block';
        
        const timestamp = Date.now();
        const response = await fetch(`Mapdata.json?v=${timestamp}`);
        if (!response.ok) throw new Error('Failed to load map data');
        
        const mapData = await response.json();
        
        const mapPromises = mapData.map(async (mapArray) => {
            if (!Array.isArray(mapArray) || mapArray.length < 7) return null;
            const [link, mapName, artist, mapper, difficulty, patterns, isNew, starRating, info] = mapArray;
            
            const mapObj = {
                link,
                mapName,
                artist,
                mapper,
                difficulty,
                patterns,
                isNew: isNew || false,
                starRating: starRating ? parseFloat(starRating) : null,
                info: info || null,
                duration: null,
                noteCount: null
            };
            
            try {
                const rawLink = link.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
                const mapResponse = await fetch(rawLink);
                if (mapResponse.ok) {
                    const mapContent = await mapResponse.text();
                    
                    const firstCommaIndex = mapContent.indexOf(',');
                    if (firstCommaIndex !== -1) {
                        const notesData = mapContent.substring(firstCommaIndex + 1);
                        const noteArray = notesData.split(',');
                        mapObj.noteCount = noteArray.length;
                        
                        if (noteArray.length > 0) {
                            try {
                                const firstNote = noteArray[0];
                                const firstNoteParts = firstNote.split('|');
                                const startTime = parseFloat(firstNoteParts[2]) || 0;
                                
                                const lastNote = noteArray[noteArray.length - 1];
                                const lastNoteParts = lastNote.split('|');
                                const endTime = parseFloat(lastNoteParts[2]) || 0;
                                
                                mapObj.duration = Math.max(0, endTime - startTime);
                            } catch (e) {
                            }
                        }
                    }
                }
            } catch (err) {
            }
            
            return mapObj;
        });
        
        maps = (await Promise.all(mapPromises)).filter(map => map !== null);
        initRangeSliders();
        filterAndRenderMaps();
    } catch (error) {
        loadingSpinner.style.display = 'none';
        mapGrid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ff6b6b;">
                <h3>Failed to Load Map Data</h3>
                <p>${error.message}</p>
                <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer;">Retry</button>
            </div>
        `;
    }
}

function loadChangelog() {
    const container = document.getElementById('changelogContent');
    container.innerHTML = '<p style="text-align: center; color: #666;">Loading changelog...</p>';
    
    fetch('Changelog.json?v=' + Date.now())
        .then(response => {
            if (!response.ok) throw new Error('Failed to load changelog');
            return response.json();
        })
        .then(changelogData => {
            container.innerHTML = '';
            
            changelogData.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'changelog-entry';
                
                const changes = log.changes.map(c => `<li>${c}</li>`).join('');
                
                entry.innerHTML = `
                    <div class="changelog-version">${log.version}</div>
                    <div class="changelog-date">${log.date}</div>
                    <ul class="changelog-changes">${changes}</ul>
                `;
                container.appendChild(entry);
            });
        })
        .catch(error => {
            console.error('Failed to load changelog:', error);
            container.innerHTML = '<p style="text-align: center; color: #ff6b6b;">Failed to load changelog</p>';
        });
}

document.addEventListener('DOMContentLoaded', () => {
    checkCookieConsent();
    loadMapData();
});
</script>
</body>
</html>
